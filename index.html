<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BirthSafe NG Portal</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style type="text/tailwindcss">
        @theme { --color-birthsafe: #db2777; --color-birthsafe-light: #fdf2f8; }
    </style>
</head>
<body class="bg-birthsafe-light antialiased font-sans text-gray-900">

    <!-- === VIEW 1: CUSTOMER FORM === -->
    <div id="customer-view" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden border border-pink-100">
            <div class="bg-birthsafe p-6 text-center text-white">
                <h1 class="text-2xl font-bold">BirthSafe NG</h1>
                <p class="text-pink-100 text-sm mt-1">Payment Verification Portal</p>
            </div>
            
            <form id="payment-form" class="p-6 space-y-3">
                <input type="text" id="fullName" placeholder="Full Name" required class="w-full p-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-birthsafe">
                <input type="email" id="email" placeholder="Email Address" required class="w-full p-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-birthsafe">
                
                <!-- Updated Plans -->
                <select id="plan" class="w-full p-3 border border-gray-200 rounded-xl bg-white outline-none">
                    <option value="20800">Basic Plan (‚Ç¶20,800)</option>
                    <option value="25000">Standard Plan (‚Ç¶25,000)</option>
                    <option value="32000">Premium Plan (‚Ç¶32,000)</option>
                </select>

                <div class="flex gap-2">
                    <input type="text" id="country" placeholder="Country" required class="w-full p-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-birthsafe">
                    <input type="text" id="state" placeholder="State" required class="w-full p-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-birthsafe">
                </div>

                <input type="tel" id="telegram" placeholder="Telegram Number" required class="w-full p-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-birthsafe">
                
                <!-- Multi-Image Upload -->
                <div class="border-2 border-dashed border-pink-200 rounded-xl p-4 text-center bg-pink-50 relative cursor-pointer hover:bg-pink-100 transition">
                    <input type="file" id="receipts" accept="image/*" multiple required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    <div class="flex flex-col items-center">
                        <span class="text-2xl mb-1">üì∏</span>
                        <p class="text-birthsafe font-bold text-sm">Upload Receipt(s)</p>
                        <p class="text-xs text-gray-500">Select multiple if paid in batches</p>
                        <p id="file-count" class="text-xs font-bold mt-1 text-gray-700"></p>
                    </div>
                </div>

                <button type="submit" id="submit-btn" class="w-full bg-birthsafe text-white py-3 rounded-xl font-bold shadow-lg hover:bg-pink-700">
                    Submit Verification
                </button>
            </form>

            <div id="success-msg" class="hidden p-10 text-center animate-bounce">
                <h2 class="text-3xl font-bold text-gray-800">‚úÖ Received!</h2>
                <p class="mt-2 text-gray-500">Check your email & Telegram in 24h.</p>
            </div>
        </div>
    </div>

    <!-- === VIEW 2: ADMIN LIST === -->
    <div id="admin-list-view" class="hidden min-h-screen p-4 max-w-md mx-auto">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">üìã Payment Requests</h2>
        <div id="list-container" class="space-y-3 pb-20">Loading...</div>
    </div>

    <!-- === VIEW 3: ADMIN DETAIL === -->
    <div id="admin-detail-view" class="hidden min-h-screen p-4 flex items-center justify-center">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden relative">
            <div class="bg-gray-800 p-4 text-white flex justify-between items-center">
                <span class="font-bold">Review Payment</span>
                <span id="det-status" class="text-xs uppercase font-bold bg-yellow-400 text-black px-2 py-1 rounded">Pending</span>
            </div>
            
            <div class="p-5 space-y-3 h-[80vh] overflow-y-auto">
                <div class="text-center">
                    <h2 id="det-name" class="text-xl font-bold text-gray-900">-</h2>
                    <p class="text-birthsafe font-bold text-2xl">‚Ç¶<span id="det-plan">-</span></p>
                    <p id="det-loc" class="text-sm text-gray-500">-</p>
                    <p id="det-contact" class="text-sm font-bold text-blue-600">-</p>
                    <p id="det-email" class="text-xs text-gray-400 mt-1">-</p>
                </div>
                
                <!-- Image Grid -->
                <p class="font-bold text-sm text-gray-700">Receipts:</p>
                <div id="det-img-grid" class="grid grid-cols-2 gap-2"></div>
                
                <!-- Action Buttons -->
                <div id="action-buttons" class="flex gap-3 pt-4 pb-8">
                    <button onclick="updateStatus('verified')" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold shadow hover:bg-green-700">Verify ‚úÖ</button>
                    <button onclick="showRejectModal()" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold shadow hover:bg-red-700">Reject ‚ùå</button>
                </div>
            </div>
        </div>
    </div>

    <!-- REJECTION MODAL -->
    <div id="reject-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6">
            <h3 class="font-bold text-lg mb-2">Reason for Rejection</h3>
            <textarea id="reject-reason" class="w-full border p-2 rounded-lg h-32 text-sm" placeholder="e.g., Receipt date is invalid..."></textarea>
            <div class="flex gap-2 mt-4">
                <button onclick="closeRejectModal()" class="flex-1 bg-gray-200 py-2 rounded-lg">Cancel</button>
                <button onclick="submitRejection()" class="flex-1 bg-red-600 text-white py-2 rounded-lg">Confirm Reject</button>
            </div>
        </div>
    </div>

    <script>
        const { createClient } = window.supabase;
        
        // CONFIG
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // Replace
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY'; // Replace
        const BACKEND_URL = 'https://birthsafe-backend.onrender.com'; // Replace with your Render URL

        const sb = createClient(SUPABASE_URL, SUPABASE_KEY);
        const tg = window.Telegram?.WebApp;
        if(tg) tg.expand();

        const params = new URLSearchParams(window.location.search);
        const pid = params.get('id');
        const view = params.get('view');

        // FILE COUNT UI
        document.getElementById('receipts').addEventListener('change', function(){
            document.getElementById('file-count').innerText = `${this.files.length} file(s) selected`;
        });

        // ROUTER
        if (pid) {
            document.getElementById('admin-detail-view').classList.remove('hidden');
            loadDetail(pid);
        } else if (view === 'admin') {
            document.getElementById('admin-list-view').classList.remove('hidden');
            loadList();
        } else {
            document.getElementById('customer-view').classList.remove('hidden');
        }

        // 1. SUBMIT
        document.getElementById('payment-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.innerText = "Uploading Images..."; btn.disabled = true;

            try {
                const files = document.getElementById('receipts').files;
                if(files.length === 0) throw new Error("Please upload at least one receipt.");

                let uploadedUrls = [];

                // Loop through all files
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileName = `${Date.now()}_${i}_${file.name.replace(/[^a-zA-Z0-9.]/g, '')}`;
                    const { error: upErr } = await sb.storage.from('receipts').upload(fileName, file);
                    if (upErr) throw upErr;
                    
                    const { data: { publicUrl } } = sb.storage.from('receipts').getPublicUrl(fileName);
                    uploadedUrls.push(publicUrl);
                }

                btn.innerText = "Sending Data...";

                const payload = {
                    fullName: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    plan: document.getElementById('plan').value,
                    country: document.getElementById('country').value,
                    state: document.getElementById('state').value,
                    telegram: document.getElementById('telegram').value,
                    receiptUrls: uploadedUrls // Sending Array
                };

                const res = await fetch(`${BACKEND_URL}/api/submit-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if(!res.ok) throw new Error("Server error");

                document.getElementById('payment-form').classList.add('hidden');
                document.getElementById('success-msg').classList.remove('hidden');
            } catch (err) { 
                alert(err.message); 
                btn.disabled = false; 
                btn.innerText = "Submit Verification"; 
            }
        };

        // 2. LIST
        async function loadList() {
            const { data, error } = await sb.from('payments').select('*').order('created_at', { ascending: false });
            const container = document.getElementById('list-container');
            
            if (error) {
                container.innerHTML = `<p class="text-center text-red-500">Error loading data</p>`;
                return;
            }

            container.innerHTML = data.map(p => `
                <div onclick="window.location.search='?id=${p.id}'" 
                     class="bg-white p-4 rounded-xl shadow-sm border-l-4 ${p.status === 'verified' ? 'border-green-500' : p.status === 'rejected' ? 'border-red-500' : 'border-yellow-400'} flex justify-between items-center cursor-pointer hover:bg-gray-50">
                    <div>
                        <p class="font-bold text-gray-800">${p.full_name}</p>
                        <p class="text-xs text-gray-500">‚Ç¶${p.plan_amount} ‚Ä¢ ${p.receipt_urls ? p.receipt_urls.length : 1} Receipt(s)</p>
                    </div>
                    <span class="text-xs font-bold uppercase px-2 py-1 rounded bg-gray-100">${p.status}</span>
                </div>
            `).join('');
        }

        // 3. DETAIL
        async function loadDetail(id) {
            const { data } = await sb.from('payments').select('*').eq('id', id).single();
            if (data) {
                document.getElementById('det-name').innerText = data.full_name;
                document.getElementById('det-plan').innerText = data.plan_amount;
                document.getElementById('det-email').innerText = data.email;
                document.getElementById('det-loc').innerText = `${data.state_province}, ${data.country}`;
                document.getElementById('det-contact').innerText = "TG: " + (data.telegram_number || "N/A");
                
                // Load Images Grid
                const grid = document.getElementById('det-img-grid');
                grid.innerHTML = data.receipt_urls.map(url => `
                    <a target="_blank" href="${url}" class="block border rounded-lg overflow-hidden h-32 bg-gray-100">
                        <img src="${url}" class="w-full h-full object-cover hover:scale-105 transition">
                    </a>
                `).join('');
                
                const st = document.getElementById('det-status');
                st.innerText = data.status;
                if(data.status !== 'pending') {
                    document.getElementById('action-buttons').classList.add('hidden'); // Hide buttons if already processed
                }
            }
        }

        // 4. UPDATE STATUS LOGIC
        async function updateStatus(s, reason = null) {
            const btnText = s === 'verified' ? "Verifying..." : "Rejecting...";
            // Optional: Loading UI indication here
            
            try {
                const params = new URLSearchParams(window.location.search);
                await fetch(`${BACKEND_URL}/api/verify-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        id: params.get('id'), 
                        status: s,
                        reason: reason 
                    })
                });
                alert("Status Updated & Email Sent!");
                if(tg && tg.initData) tg.close();
                else window.location.search = '?view=admin';
            } catch(e) { alert("Error updating status"); }
        }

        // REJECTION UI HELPERS
        function showRejectModal() { document.getElementById('reject-modal').classList.remove('hidden'); }
        function closeRejectModal() { document.getElementById('reject-modal').classList.add('hidden'); }
        function submitRejection() {
            const r = document.getElementById('reject-reason').value;
            if(!r) return alert("Please write a reason.");
            updateStatus('rejected', r);
            closeRejectModal();
        }
    </script>
</body>
</html>
