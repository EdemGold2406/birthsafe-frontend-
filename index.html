<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BirthSafe NG Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style type="text/tailwindcss">
        @theme { --color-birthsafe: #db2777; --color-birthsafe-light: #fdf2f8; }
    </style>
</head>
<body class="bg-birthsafe-light antialiased font-sans text-gray-900">

    <div id="customer-view" class="hidden min-h-screen flex items-center justify-center p-4">
        <!-- ... (Keep your existing customer form HTML here) ... -->
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-6">
            <h1 class="text-2xl font-bold text-birthsafe text-center">BirthSafe NG</h1>
            <form id="payment-form" class="space-y-4 mt-4">
                <input type="text" id="fullName" placeholder="Full Name" required class="w-full p-3 border rounded-xl">
                <input type="email" id="email" placeholder="Email" required class="w-full p-3 border rounded-xl">
                <select id="plan" class="w-full p-3 border rounded-xl">
                    <option value="20800">Basic (â‚¦20,800)</option>
                    <option value="25000">Standard (â‚¦25,000)</option>
                    <option value="32000">Premium (â‚¦32,000)</option>
                </select>
                <input type="file" id="receipts" multiple required class="w-full">
                <button type="submit" id="submit-btn" class="w-full bg-birthsafe text-white py-3 rounded-xl font-bold">Submit</button>
            </form>
        </div>
    </div>

    <div id="admin-list-view" class="hidden min-h-screen p-4">
        <h2 class="text-2xl font-bold mb-4">ðŸ“‹ Payment Requests</h2>
        <div id="list-container" class="space-y-3"></div>
    </div>

    <div id="admin-detail-view" class="hidden min-h-screen p-4 flex flex-col items-center">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-md">
            <h2 id="det-name" class="text-xl font-bold"></h2>
            <div id="det-img-grid" class="grid grid-cols-2 gap-2 my-4"></div>
            <div id="action-buttons" class="flex gap-2">
                <button onclick="updateStatus('verified')" class="bg-green-600 text-white p-3 rounded-xl flex-1">Verify</button>
                <button onclick="showRejectModal()" class="bg-red-600 text-white p-3 rounded-xl flex-1">Reject</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://qgrluobqmyzpaeblonbx.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_V2uL6AajUGNGUfazQXj78Q_klGpJ4Ad';
        const BACKEND_URL = 'https://birthsafe-backend.onrender.com';

        const { createClient } = window.supabase;
        const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

        // ROUTER LOGIC - Wrapped in window.onload to prevent blank screen
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const pid = params.get('id');
            const view = params.get('view');

            if (pid) {
                document.getElementById('admin-detail-view').classList.remove('hidden');
                loadDetail(pid);
            } else if (view === 'admin') {
                document.getElementById('admin-list-view').classList.remove('hidden');
                loadList();
            } else {
                document.getElementById('customer-view').classList.remove('hidden');
            }
        };

        async function loadList() {
            const { data } = await sb.from('payments').select('*').order('created_at', { ascending: false });
            document.getElementById('list-container').innerHTML = data.map(p => `
                <div onclick="window.location.search='?id=${p.id}'" class="bg-white p-4 rounded-xl shadow cursor-pointer">
                    <b>${p.full_name}</b> - â‚¦${p.plan_amount} (${p.status})
                </div>
            `).join('');
        }

        async function loadDetail(id) {
            const { data } = await sb.from('payments').select('*').eq('id', id).single();
            document.getElementById('det-name').innerText = data.full_name;
            document.getElementById('det-img-grid').innerHTML = data.receipt_urls.map(url => `
                <img src="${url}" class="rounded-lg h-32 w-full object-cover">
            `).join('');
        }

        async function updateStatus(s) {
            const pid = new URLSearchParams(window.location.search).get('id');
            await fetch(`${BACKEND_URL}/api/verify-payment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: pid, status: s })
            });
            alert("Updated!");
            window.location.search = "?view=admin";
        }

        // Form Submit Logic
        document.getElementById('payment-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.disabled = true; btn.innerText = "Processing...";

            try {
                const files = document.getElementById('receipts').files;
                let uploadedUrls = [];
                for (let file of files) {
                    const name = `${Date.now()}_${file.name}`;
                    await sb.storage.from('receipts').upload(name, file);
                    const { data: { publicUrl } } = sb.storage.from('receipts').getPublicUrl(name);
                    uploadedUrls.push(publicUrl);
                }

                await fetch(`${BACKEND_URL}/api/submit-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fullName: document.getElementById('fullName').value,
                        email: document.getElementById('email').value,
                        plan: document.getElementById('plan').value,
                        receiptUrls: uploadedUrls
                    })
                });
                alert("Submitted!");
                location.reload();
            } catch (err) { alert("Error"); btn.disabled = false; }
        };
    </script>
</body>
</html>
