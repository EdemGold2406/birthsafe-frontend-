<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BirthSafe NG Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style type="text/tailwindcss">
        @theme { --color-birthsafe: #db2777; --color-birthsafe-light: #fdf2f8; }
    </style>
</head>
<body class="bg-birthsafe-light antialiased font-sans text-gray-900">

    <!-- CUSTOMER VIEW -->
    <div id="customer-view" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden">
            <div class="bg-birthsafe p-6 text-center text-white">
                <h1 class="text-2xl font-bold">BirthSafe NG</h1>
                <p class="text-pink-100 text-sm">Payment Verification</p>
            </div>
            <form id="payment-form" class="p-6 space-y-4">
                <input type="text" id="fullName" placeholder="Full Name" required class="w-full p-3 border rounded-xl outline-none border-gray-300">
                <select id="plan" class="w-full p-3 border rounded-xl bg-white border-gray-300">
                    <option value="35k Plan">Standard (₦35,000)</option>
                    <option value="50k Plan">Premium (₦50,000)</option>
                </select>
                <input type="tel" id="whatsapp" placeholder="WhatsApp Number" required class="w-full p-3 border rounded-xl border-gray-300">
                <div class="border-2 border-dashed border-pink-200 rounded-xl p-4 text-center bg-pink-50 relative">
                    <input type="file" id="receipt" accept="image/*" required class="absolute inset-0 opacity-0 cursor-pointer">
                    <p class="text-birthsafe font-bold text-sm">Upload Receipt</p>
                </div>
                <button type="submit" id="submit-btn" class="w-full bg-birthsafe text-white py-4 rounded-xl font-bold shadow-lg">Submit Verification</button>
            </form>
            <div id="success-msg" class="hidden p-10 text-center"><h2 class="text-3xl font-bold">✅ Sent!</h2></div>
        </div>
    </div>

    <!-- ADMIN LIST VIEW -->
    <div id="admin-list-view" class="hidden min-h-screen p-4 max-w-md mx-auto">
        <h2 class="text-2xl font-bold mb-4">All Payments</h2>
        <div id="list-container" class="space-y-3">Loading...</div>
    </div>

    <!-- ADMIN DETAIL VIEW -->
    <div id="admin-detail-view" class="hidden min-h-screen p-4">
        <div class="max-w-md mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="bg-gray-800 p-4 text-white flex justify-between">
                <span class="font-bold">Review</span>
                <span id="det-status" class="bg-yellow-400 text-black px-2 rounded text-xs uppercase font-bold">Pending</span>
            </div>
            <div class="p-6 space-y-4 text-center">
                <h2 id="det-name" class="text-2xl font-bold">-</h2>
                <p id="det-plan" class="text-birthsafe font-bold">-</p>
                <img id="det-img" src="" class="w-full h-auto rounded border">
                <div class="flex gap-3 pt-4">
                    <button onclick="updateStatus('verified')" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold">Verify ✅</button>
                    <button onclick="updateStatus('rejected')" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold">Reject ❌</button>
                </div>
                <button onclick="window.location.search='?view=admin'" class="text-sm text-gray-400 mt-2">Back to List</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const { createClient } = window.supabase;
        const SUPABASE_URL = 'https://qgrluobqmyzpaeblonbx.supabase.co';
        const SUPABASE_KEY = 'sb_secret_nO2pexNfAlx0Xv-0BaMXVw_OVRdA28J';
        
        // PASTE YOUR RENDER BACKEND URL HERE (NO SLASH AT END)
        const BACKEND_URL = 'YOUR_BACKEND_URL_HERE'; 

        const sb = createClient(SUPABASE_URL, SUPABASE_KEY);
        const tg = window.Telegram?.WebApp;
        if(tg) tg.expand();

        const params = new URLSearchParams(window.location.search);
        const pid = params.get('id');
        const view = params.get('view');

        // ROUTER
        if (pid) {
            document.getElementById('admin-detail-view').classList.remove('hidden');
            loadDetail(pid);
        } else if (view === 'admin') {
            document.getElementById('admin-list-view').classList.remove('hidden');
            loadList();
        } else {
            document.getElementById('customer-view').classList.remove('hidden');
        }

        // 1. CUSTOMER SUBMIT
        document.getElementById('payment-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            btn.innerText = "Processing..."; btn.disabled = true;

            try {
                const file = document.getElementById('receipt').files[0];
                const fileName = `${Date.now()}_${file.name.replace(/\s/g, '')}`;
                const { error: upErr } = await sb.storage.from('receipts').upload(fileName, file);
                if (upErr) throw upErr;

                const { data: { publicUrl } } = sb.storage.from('receipts').getPublicUrl(fileName);

                await fetch(`${BACKEND_URL}/api/submit-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fullName: document.getElementById('fullName').value,
                        plan: document.getElementById('plan').value,
                        whatsapp: document.getElementById('whatsapp').value,
                        receiptUrl: publicUrl
                    })
                });

                document.getElementById('payment-form').classList.add('hidden');
                document.getElementById('success-msg').classList.remove('hidden');
            } catch (err) { alert(err.message); btn.disabled = false; }
        };

        // 2. ADMIN FUNCTIONS
        async function loadList() {
            const { data } = await sb.from('payments').select('*').order('created_at', { ascending: false });
            document.getElementById('list-container').innerHTML = data.map(p => `
                <div onclick="window.location.search='?id=${p.id}'" class="bg-white p-4 rounded-xl shadow border-l-4 ${p.status=='verified'?'border-green-500':'border-yellow-500'} flex justify-between cursor-pointer">
                    <div><p class="font-bold">${p.full_name}</p><p class="text-xs text-gray-500">${p.plan_amount} • ${p.status}</p></div><span>❯</span>
                </div>`).join('');
        }

        async function loadDetail(id) {
            const { data } = await sb.from('payments').select('*').eq('id', id).single();
            if(data) {
                document.getElementById('det-name').innerText = data.full_name;
                document.getElementById('det-plan').innerText = data.plan_amount;
                document.getElementById('det-img').src = data.receipt_url;
                document.getElementById('det-status').innerText = data.status;
            }
        }

        async function updateStatus(s) {
            if(!confirm(`Mark as ${s}?`)) return;
            await fetch(`${BACKEND_URL}/api/verify-payment`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: pid, status: s })
            });
            alert('Updated!');
            window.location.search = '?view=admin';
        }
    </script>
</body>
</html>
