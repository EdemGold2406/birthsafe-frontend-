<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BirthSafe NG Portal</title>
    
    <!-- 1. Libraries (Tailwind, Supabase, Telegram) -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- 2. Custom Theme Colors -->
    <style type="text/tailwindcss">
        @theme { --color-birthsafe: #db2777; --color-birthsafe-light: #fdf2f8; }
    </style>
</head>
<body class="bg-birthsafe-light antialiased font-sans text-gray-900">

    <!-- =========================================
         VIEW 1: CUSTOMER FORM (The Default View)
         ========================================= -->
    <div id="customer-view" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden border border-pink-100">
            <!-- Header -->
            <div class="bg-birthsafe p-6 text-center text-white">
                <h1 class="text-2xl font-bold tracking-tight">BirthSafe NG</h1>
                <p class="text-pink-100 text-sm mt-1 font-medium">Payment Verification Portal</p>
            </div>
            
            <!-- Form -->
            <form id="payment-form" class="p-6 space-y-4">
                
                <!-- Name -->
                <div>
                    <input type="text" id="fullName" placeholder="Full Name" required 
                        class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-birthsafe outline-none transition-all placeholder-gray-400">
                </div>

                <!-- Plan -->
                <div class="relative">
                    <select id="plan" class="w-full p-3 border border-gray-200 rounded-xl bg-white focus:ring-2 focus:ring-birthsafe outline-none appearance-none text-gray-700">
                        <option value="35k Plan">Standard Plan (‚Ç¶35,000)</option>
                        <option value="50k Plan">Premium Plan (‚Ç¶50,000)</option>
                        <option value="100k Plan">Exclusive Plan (‚Ç¶100,000)</option>
                    </select>
                    <!-- Custom Arrow Icon -->
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                        <svg class="h-4 w-4 fill-current" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                    </div>
                </div>

                <!-- WhatsApp -->
                <div>
                    <input type="tel" id="whatsapp" placeholder="WhatsApp Number (080...)" required 
                        class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-birthsafe outline-none transition-all placeholder-gray-400">
                </div>

                <!-- Telegram (Optional) -->
                <div>
                    <input type="tel" id="telegram" placeholder="Telegram Number (Optional)" 
                        class="w-full p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-birthsafe outline-none transition-all placeholder-gray-400">
                </div>
                
                <!-- Receipt Upload -->
                <div class="border-2 border-dashed border-pink-200 rounded-xl p-6 text-center bg-pink-50 relative hover:bg-pink-100 transition cursor-pointer group">
                    <input type="file" id="receipt" accept="image/*" required class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    <div class="flex flex-col items-center">
                        <span class="text-3xl mb-2 group-hover:scale-110 transition-transform">üìé</span>
                        <p class="text-birthsafe font-bold">Upload Payment Receipt</p>
                        <p class="text-xs text-gray-400 mt-1">Tap here to browse images</p>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submit-btn" 
                    class="w-full bg-birthsafe text-white py-4 rounded-xl font-bold shadow-lg shadow-pink-200 hover:bg-pink-700 active:scale-95 transition-all">
                    Submit Verification
                </button>
            </form>

            <!-- Success Message (Hidden by default) -->
            <div id="success-msg" class="hidden p-10 text-center animate-bounce">
                <div class="text-6xl mb-4">‚úÖ</div>
                <h2 class="text-2xl font-bold text-gray-800">Received!</h2>
                <p class="mt-2 text-gray-500 leading-relaxed">We will verify your payment within 24-48 hours. Please check your WhatsApp.</p>
            </div>
        </div>
    </div>

    <!-- =========================================
         VIEW 2: ADMIN LIST (See All Payments)
         ========================================= -->
    <div id="admin-list-view" class="hidden min-h-screen p-4 max-w-md mx-auto">
        <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-2">
            <span>üìã</span> All Payments
        </h2>
        <div id="list-container" class="space-y-3 pb-20">
            <p class="text-center text-gray-400 mt-10">Loading payments...</p>
        </div>
    </div>

    <!-- =========================================
         VIEW 3: ADMIN DETAIL (Verify Single Payment)
         ========================================= -->
    <div id="admin-detail-view" class="hidden min-h-screen p-4 flex items-center justify-center">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
            <!-- Admin Header -->
            <div class="bg-gray-800 p-4 text-white flex justify-between items-center">
                <span class="font-bold flex items-center gap-2">üõ°Ô∏è Admin Review</span>
                <span id="det-status" class="text-xs uppercase font-bold bg-yellow-400 text-black px-2 py-1 rounded">Pending</span>
            </div>
            
            <div class="p-6 space-y-5">
                <!-- User Details -->
                <div class="text-center space-y-1">
                    <h2 id="det-name" class="text-2xl font-bold text-gray-900">-</h2>
                    <p id="det-plan" class="text-birthsafe font-bold text-lg">-</p>
                    <div class="flex justify-center items-center gap-2 text-sm text-gray-500 mt-2">
                        <span>üì±</span> <span id="det-wa">-</span>
                    </div>
                </div>
                
                <!-- Receipt Image -->
                <div class="border-4 border-gray-100 rounded-xl overflow-hidden bg-gray-50 shadow-inner">
                    <a id="det-img-link" target="_blank" href="#">
                        <img id="det-img" src="" class="w-full h-64 object-contain hover:scale-105 transition-transform duration-500">
                    </a>
                </div>
                <p class="text-center text-xs text-gray-400">Click image to view full size</p>
                
                <!-- Action Buttons -->
                <div class="flex gap-3 pt-2">
                    <button onclick="updateStatus('verified')" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-md transition-colors flex items-center justify-center gap-2">
                        <span>‚úÖ</span> Verify
                    </button>
                    <button onclick="updateStatus('rejected')" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold shadow-md transition-colors flex items-center justify-center gap-2">
                        <span>‚ùå</span> Reject
                    </button>
                </div>
                
                <button onclick="window.location.search='?view=admin'" class="w-full text-gray-400 text-sm py-3 hover:text-gray-600 transition-colors">
                    ‚Üê Back to List
                </button>
            </div>
        </div>
    </div>

    <!-- =========================================
         JAVASCRIPT LOGIC
         ========================================= -->
    <script>
        // 1. SETUP & CONFIGURATION
        const { createClient } = window.supabase;
        
        const SUPABASE_URL = 'https://qgrluobqmyzpaeblonbx.supabase.co';
        const SUPABASE_KEY = 'sb_secret_nO2pexNfAlx0Xv-0BaMXVw_OVRdA28J';
        
        // LINKED TO YOUR DEPLOYED BACKEND
        const BACKEND_URL = 'https://birthsafe-backend.onrender.com';

        const sb = createClient(SUPABASE_URL, SUPABASE_KEY);
        const tg = window.Telegram?.WebApp;
        
        // Expand to full screen if opened inside Telegram
        if(tg) tg.expand();

        // 2. ROUTING (Determines which screen to show)
        const params = new URLSearchParams(window.location.search);
        const pid = params.get('id');
        const view = params.get('view');

        if (pid) {
            // If URL has ?id=... -> Show Admin Detail View
            document.getElementById('admin-detail-view').classList.remove('hidden');
            loadDetail(pid);
        } else if (view === 'admin') {
            // If URL has ?view=admin -> Show Admin List View
            document.getElementById('admin-list-view').classList.remove('hidden');
            loadList();
        } else {
            // Default -> Show Customer Form
            document.getElementById('customer-view').classList.remove('hidden');
        }

        // 3. CUSTOMER: SUBMIT LOGIC
        document.getElementById('payment-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerText;
            
            // Disable button
            btn.innerText = "Uploading Receipt...";
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            try {
                // A. Validate File
                const fileInput = document.getElementById('receipt');
                if (!fileInput.files || fileInput.files.length === 0) {
                    throw new Error("Please select a receipt image.");
                }
                const file = fileInput.files[0];

                // B. Upload to Supabase Storage
                const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '')}`; // Clean filename
                const { error: uploadError } = await sb.storage.from('receipts').upload(fileName, file);
                
                if (uploadError) throw new Error("Image upload failed: " + uploadError.message);

                // C. Get Public URL
                const { data: { publicUrl } } = sb.storage.from('receipts').getPublicUrl(fileName);

                // D. Send Data to Backend (Node.js)
                const payload = {
                    fullName: document.getElementById('fullName').value,
                    plan: document.getElementById('plan').value,
                    whatsapp: document.getElementById('whatsapp').value,
                    telegram: document.getElementById('telegram').value,
                    receiptUrl: publicUrl
                };

                const res = await fetch(`${BACKEND_URL}/api/submit-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) throw new Error("Server submission failed. Please try again.");

                // E. Show Success
                document.getElementById('payment-form').classList.add('hidden');
                document.getElementById('success-msg').classList.remove('hidden');

            } catch (err) {
                alert("‚ö†Ô∏è Error: " + err.message);
                // Reset Button
                btn.disabled = false;
                btn.innerText = originalText;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        };

        // 4. ADMIN: LOAD LIST
        async function loadList() {
            const { data, error } = await sb.from('payments').select('*').order('created_at', { ascending: false });
            const container = document.getElementById('list-container');
            
            if (error) {
                container.innerHTML = '<p class="text-red-500 text-center">Error loading data.</p>';
                return;
            }

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-10 bg-white rounded-xl shadow-sm"><p class="text-4xl mb-2">üì≠</p><p>No payments found.</p></div>';
                return;
            }

            container.innerHTML = data.map(p => `
                <div onclick="window.location.search='?id=${p.id}'" 
                     class="bg-white p-4 rounded-xl shadow-sm border-l-4 ${getStatusColor(p.status)} flex justify-between items-center cursor-pointer active:scale-95 transition-transform">
                    <div>
                        <p class="font-bold text-gray-800 text-lg">${p.full_name}</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">${p.plan_amount}</span>
                            <span class="text-xs uppercase font-bold text-gray-500">${p.status}</span>
                        </div>
                    </div>
                    <span class="text-gray-300 font-bold text-2xl">‚Ä∫</span>
                </div>
            `).join('');
        }

        // 5. ADMIN: LOAD DETAIL
        async function loadDetail(id) {
            const { data, error } = await sb.from('payments').select('*').eq('id', id).single();
            if (data) {
                document.getElementById('det-name').innerText = data.full_name;
                document.getElementById('det-plan').innerText = data.plan_amount;
                document.getElementById('det-wa').innerText = data.whatsapp_number;
                document.getElementById('det-img').src = data.receipt_url;
                document.getElementById('det-img-link').href = data.receipt_url;
                
                const statusBadge = document.getElementById('det-status');
                statusBadge.innerText = data.status;
                
                // Colorize Badge
                if(data.status === 'verified') statusBadge.className = "text-xs uppercase font-bold bg-green-600 text-white px-3 py-1 rounded-full";
                else if(data.status === 'rejected') statusBadge.className = "text-xs uppercase font-bold bg-red-600 text-white px-3 py-1 rounded-full";
                else statusBadge.className = "text-xs uppercase font-bold bg-yellow-400 text-black px-3 py-1 rounded-full";
            }
        }

        // 6. ADMIN: UPDATE STATUS
        async function updateStatus(newStatus) {
            if(!confirm(`Are you sure you want to mark this as ${newStatus}?`)) return;
            
            // Optimistic Update (Make it look fast)
            document.getElementById('det-status').innerText = "Updating...";
            
            try {
                const params = new URLSearchParams(window.location.search);
                const currentId = params.get('id');

                await fetch(`${BACKEND_URL}/api/verify-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: currentId, status: newStatus })
                });

                alert(`Success! Payment marked as ${newStatus}`);
                
                // If in Telegram Bot, close the window. If in Browser, go back to list.
                if(tg && tg.initData) tg.close();
                else window.location.search = '?view=admin';

            } catch (err) {
                alert("Failed to update status.");
            }
        }

        // Helper: Status Border Colors
        function getStatusColor(status) {
            if (status === 'verified') return 'border-green-500';
            if (status === 'rejected') return 'border-red-500';
            return 'border-yellow-400';
        }
    </script>
</body>
</html>
